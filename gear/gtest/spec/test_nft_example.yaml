title: Test NFT-example

programs:
  - id: 1
    path: nft_example.wasm
    init_message:
      kind: custom
      value:
        name: "NFT collection"
        symbol: "NFT"
        base_uri: "https://"

fixtures:
  - title: mint/burn
    messages:
      - &mint
        destination: 1
        source: &source
          kind: id
          value: 2
        payload: &payload_mint
          kind: custom
          value:
            mint: 
      - *mint
      - &burn
        destination: 1
        source: *source
        payload:
          kind: custom
          value:
            burn: 1
      - *burn
      
    expected:
      - log:
        - &mint_success
          destination: 2
          payload:
            kind: custom
            value:
              transfer:
                from: &zero 0x0000000000000000000000000000000000000000000000000000000000000000
                to: &user_1 0x0200000000000000000000000000000000000000000000000000000000000000
                token_id: 0               
        - <<: *mint_success
          destination: 2
          payload:
            kind: custom
            value:
              transfer:
                from: *zero
                to: *user_1
                token_id: 1
        - &burn_success
          destination: 2
          payload:
            kind: custom
            value:
              transfer:
                from: *user_1
                to: *zero
                token_id: 1
        - destination: 2
          exitCode: 1

  - title: ownerOf
    messages:
      - *mint
      - <<: *mint
        destination: 1
        source:
          kind: id
          value: 3
        payload: *payload_mint
      - &owner_of
        destination: 1
        source: *source
        payload: 
          kind: custom
          value:
            ownerOf: 0 
      - <<: *owner_of
        destination: 1
        source: *source
        payload: 
          kind: custom
          value:
            ownerOf: 1 
      - <<: *owner_of
        destination: 1
        source: *source
        payload: 
          kind: custom
          value:
            ownerOf: 2 
    expected:
    - log:
      - *mint_success            
      - <<: *mint_success
        destination: 3
        payload:
          kind: custom
          value:
            transfer:
              from: *zero
              to: &user_2 0x0300000000000000000000000000000000000000000000000000000000000000
              token_id: 1
      - &owner_of_reply
        destination: 2
        payload:
          kind: custom
          value:
            ownerOf: *user_1
      - <<: *owner_of_reply
        destination: 2
        payload:
          kind: custom
          value:
            ownerOf: *user_2
      - <<: *owner_of_reply
        destination: 2
        payload:
          kind: custom
          value:
            ownerOf: *zero
  
  - title: balanceOf
    messages:
      - *mint
      - *mint
      - *mint
      - &balance_of
        destination: 1
        source: *source
        payload: 
          kind: custom
          value:
            balanceOf: *user_1
      - &balance_of
        destination: 1
        source: *source
        payload: 
          kind: custom
          value:
            balanceOf: *user_2

    expected:
    - log:
      - *mint_success            
      - <<: *mint_success
        destination: 2
        payload:
          kind: custom
          value:
            transfer:
              from: *zero
              to: *user_1 
              token_id: 1
      - <<: *mint_success
        destination: 2
        payload:
          kind: custom
          value:
            transfer:
              from: *zero
              to: *user_1 
              token_id: 2
      - &balance_of_reply
        destination: 2
        payload:
          kind: custom
          value:
            balanceOf: 3
      - <<: *balance_of_reply
        destination: 2
        payload:
          kind: custom
          value:
            balanceOf: 0
  
  
  - title: transfer
    messages:
      - *mint
      - *mint
      - &transfer
        destination: 1
        source:
          kind: id
          value: 2
        payload:
          kind: custom
          value:
            transfer:
              to: *user_2
              token_id: 0
      - *owner_of  
      - <<: *transfer
        destination: 1
        source: *source
        payload:
          kind: custom
          value:
            transfer:
              to: *zero
              token_id: 1
      - <<: *transfer
        destination: 1
        source:
          kind: id
          value: 3
        payload:
          kind: custom
          value:
            transfer:
              to: &user_3 0x0400000000000000000000000000000000000000000000000000000000000000
              token_id: 1
      - <<: *transfer
        destination: 1
        source: *source
        payload:
          kind: custom
          value:
            transfer:
              to: *user_2
              token_id: 10
      - <<: *transfer
        destination: 1
        source: *source
        payload:
          kind: custom
          value:
            transfer:
              to: *user_1
              token_id: 1

    expected:
      - log:
        - *mint_success
        - <<: *mint_success
          destination: 2
          payload:
            kind: custom
            value:
              transfer:
                from: *zero
                to: *user_1
                token_id: 1 
        - &transfer_success
          destination: 2
          payload:
            kind: custom
            value:
              transfer:
                from: *user_1
                to: *user_2
                token_id: 0
        - <<: *owner_of_reply
          destination: 2
          payload:
            kind: custom
            value:
              ownerOf: *user_2
        - destination: 2
          exitCode: 1
        - destination: 3
          exitCode: 1
        - destination: 2
          exitCode: 1
        - destination: 2
          exitCode: 1

  - title: approve
    messages:
      - *mint
      - *mint
      - &approve
        destination: 1
        source: *source
        payload:
          kind: custom
          value:
            approve:
              to: *user_2
              token_id: 0
      - <<: *approve
        destination: 1
        source: *source
        payload:
          kind: custom
          value:
            approve:
              to: *zero
              token_id: 0
      - <<: *approve
        destination: 1
        source: *source
        payload:
          kind: custom
          value:
            approve:
              to: *user_1
              token_id: 0
      - <<: *approve
        destination: 1
        source:
          kind: id
          value: 3
        payload:
          kind: custom
          value:
            approve:
              to: *user_3
              token_id: 0

    expected:
      - log:
        - *mint_success
        - <<: *mint_success
          destination: 2
          payload:
            kind: custom
            value:
              transfer:
                from: *zero
                to: *user_1
                token_id: 1
        - &approve_success
          destination: 2
          payload:
            kind: custom
            value:
              approval:
                owner: *user_1
                spender: *user_2
                token_id: 0
        - destination: 2
          exitCode: 1
        - destination: 2
          exitCode: 1
        - destination: 3
          exitCode: 1
  
  - title: transfer from approved address
    messages:
      - *mint
      - *mint
      - *approve
      - &transfer
        destination: 1
        source:
          kind: id
          value: 3
        payload:
          kind: custom
          value:
            transfer:
              to: *user_3
              token_id: 0
 

    expected:
      - log:
        - *mint_success
        - <<: *mint_success
          destination: 2
          payload:
            kind: custom
            value:
              transfer:
                from: *zero
                to: *user_1
                token_id: 1
        - *approve_success
        - &transfer_success
          destination: 3
          payload:
            kind: custom
            value:
              transfer:
                from: *user_2
                to: *user_3
                token_id: 0
        # - destination: 2
        #   exitCode: 1
        # - destination: 2
        #   exitCode: 1
        # - destination: 3
        #   exitCode: 1

  - title: operator (set_approval_for_all)
    messages:
      - *mint
      - *mint
      - *mint
      - &set_approval_for_all
        destination: 1
        source: *source
        payload:
          kind: custom
          value:
            approveForAll:
              to: *user_2
              approve: true
      - <<: *transfer
        destination: 1
        source:
          kind: id
          value: 3
        payload:
          kind: custom
          value:
            transfer:
              to: *user_3
              token_id: 0
      - <<: *transfer
        destination: 1
        source:
          kind: id
          value: 3
        payload:
          kind: custom
          value:
            transfer:
              to: *user_3
              token_id: 1
      - &set_approval_for_all
        destination: 1
        source: *source
        payload:
          kind: custom
          value:
            approveForAll:
              to: *user_2
              approve: false
      - &set_approval_for_all
        destination: 1
        source: *source
        payload:
          kind: custom
          value:
            approveForAll:
              to: *zero
              approve: true
      - <<: *transfer
        destination: 1
        source:
          kind: id
          value: 3
        payload:
          kind: custom
          value:
            transfer:
              to: *user_3
              token_id: 2

    expected:
      - log:
        - *mint_success
        - <<: *mint_success
          destination: 2
          payload:
            kind: custom
            value:
              transfer:
                from: *zero
                to: *user_1
                token_id: 1
        - <<: *mint_success
          destination: 2
          payload:
            kind: custom
            value:
              transfer:
                from: *zero
                to: *user_1
                token_id: 2
        - &set_approval_for_all_success
          destination: 2
          payload:
            kind: custom
            value:
              ApprovalForAll:
                owner: *user_1
                operator: *user_2
                approved: true
        - &transfer_success
          destination: 3
          payload:
            kind: custom
            value:
              transfer:
                from: *user_2
                to: *user_3
                token_id: 0
        - &transfer_success
          destination: 3
          payload:
            kind: custom
            value:
              transfer:
                from: *user_2
                to: *user_3
                token_id: 1
        - &set_approval_for_all_success
          destination: 2
          payload:
            kind: custom
            value:
              ApprovalForAll:
                owner: *user_1
                operator: *user_2
                approved: false
        - destination: 2
          exitCode: 1
        - destination: 3
          exitCode: 1